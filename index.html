<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Two-Way Voice Translator (MQTT)</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    background: white;
    padding: 25px 30px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    max-width: 450px;
    width: 100%;
    text-align: center;
  }
  h2 { margin-bottom: 15px; color: #333; }
  select, button {
    padding: 10px;
    font-size: 16px;
    margin: 8px 4px;
    border-radius: 8px;
    border: 1px solid #ccc;
    outline: none;
    transition: 0.2s ease;
  }
  select:focus, button:hover {
    border-color: #4facfe;
    box-shadow: 0 0 5px rgba(79,172,254,0.5);
  }
  button {
    background: #4facfe;
    color: white;
    cursor: pointer;
    border: none;
    font-weight: bold;
  }
  button.reverse { background: #ff9800; }
  button:active { transform: scale(0.97); }
  p { font-size: 17px; margin: 10px 0; color: #444; }
  span { font-weight: bold; color: #222; }
</style>
</head>
<body>

<div class="container">
  <h2>ðŸ”„ Two-Way Voice Translator</h2>

  <div>
    <label>ðŸŽ§ Listen:</label>
    <select id="sourceLang"></select>
  </div>

  <div>
    <label>ðŸ—£ Translate To:</label>
    <select id="targetLang"></select>
  </div>

  <div>
    <button class="reverse" onclick="reverseLanguages()">ðŸ”„ Reverse</button>
    <button onclick="startRecognition()">ðŸŽ™ Start Speaking</button>
  </div>

  <p><b>Original:</b> <span id="original"></span></p>
  <p><b>Translated:</b> <span id="translated"></span></p>
  <p><b>Received:</b> <span id="received"></span></p>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// ===== Languages =====
const languages = {
  "auto": "Auto Detect",
  "en": "English",
  "ar": "Arabic",
  "fr": "French",
  "es": "Spanish",
  "de": "German",
  "ru": "Russian",
  "zh": "Chinese",
  "ja": "Japanese",
  "it": "Italian",
  "tr": "Turkish",
  "pt": "Portuguese",
  "ko": "Korean",
  "nl": "Dutch",
  "sv": "Swedish",
  "pl": "Polish",
  "th": "Thai",
  "id": "Indonesian"
};

// DOM elements
const originalText = document.getElementById("original");
const translatedText = document.getElementById("translated");
const receivedText = document.getElementById("received");
const sourceLangSelect = document.getElementById("sourceLang");
const targetLangSelect = document.getElementById("targetLang");

// Fill dropdowns
for (let code in languages) {
    let opt1 = document.createElement("option");
    opt1.value = code; opt1.textContent = languages[code];
    sourceLangSelect.appendChild(opt1);
    let opt2 = document.createElement("option");
    opt2.value = code; opt2.textContent = languages[code];
    targetLangSelect.appendChild(opt2);
}
sourceLangSelect.value = "auto";
targetLangSelect.value = "en";

// Reverse button
function reverseLanguages() {
    const temp = sourceLangSelect.value;
    sourceLangSelect.value = targetLangSelect.value;
    targetLangSelect.value = temp;
}

// ===== MQTT Setup =====
const clientId = "translator_" + Math.random().toString(16).substr(2, 8);
const mqttUser = "brengy";
const mqttPass = "Brengy123";
const topic = "voice-translator";

const client = mqtt.connect("wss://642b85c8c5cd4deaa63d5c7e0e9629fc.s1.eu.hivemq.cloud:8884/mqtt", {
    username: mqttUser,
    password: mqttPass,
    clientId: clientId,
    clean: true,
    reconnectPeriod: 1000
});

client.on("connect", () => {
    console.log("âœ… Connected to MQTT");
    client.subscribe(topic, (err) => {
        if (!err) console.log("ðŸ“¡ Subscribed to", topic);
    });
});

// Receive & Speak ONLY on other device
client.on("message", (t, message) => {
    try {
        const msgObj = JSON.parse(message.toString());
        if (msgObj.sender !== clientId) {
            receivedText.textContent = msgObj.text;
            speak(msgObj.text, msgObj.lang);
        }
    } catch (e) {
        console.error("Invalid MQTT message", e);
    }
});

function sendMQTT(text) {
    const payload = JSON.stringify({ sender: clientId, text: text, lang: targetLangSelect.value });
    client.publish(topic, payload);
}

// ===== Speech Recognition =====
function startRecognition() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = sourceLangSelect.value === "auto" ? "en-US" : sourceLangSelect.value;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        originalText.textContent = transcript;
        translateText(transcript, targetLangSelect.value);
    };
    recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
    };
    recognition.start();
}

// ===== Translation =====
function translateText(text, targetLang) {
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLangSelect.value}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
    fetch(url)
    .then(res => res.json())
    .then(data => {
        const translated = data[0].map(item => item[0]).join("");
        translatedText.textContent = translated;
        sendMQTT(translated); // ðŸ”¹ Only send â€” DO NOT speak here
    })
    .catch(err => console.error("Translation error:", err));
}

// ===== Text-to-Speech =====
function speak(text, langCode) {
    const msg = new SpeechSynthesisUtterance();
    msg.lang = langCode;
    msg.text = text;
    speechSynthesis.speak(msg);
}
</script>

</body>
</html>
