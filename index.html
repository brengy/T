<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>2-Way MQTT Voice Translator</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #4facfe, #00f2fe);
         margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .container { background: white; padding: 25px 30px; border-radius: 15px;
               box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-width: 420px; width: 100%; text-align: center; }
  h2 { margin-bottom: 15px; color: #333; }
  select, button { padding: 10px; font-size: 16px; margin: 8px 4px; border-radius: 8px; border: 1px solid #ccc; }
  button { background: #4facfe; color: white; cursor: pointer; border: none; font-weight: bold; }
  button.reverse { background: #ff9800; }
  p { font-size: 17px; margin: 10px 0; color: #444; }
  span { font-weight: bold; color: #222; }
</style>
</head>
<body>

<div class="container">
  <h2>🌍 2-Way Voice Translator</h2>

  <div>
    <label>🎧 Listen:</label>
    <select id="sourceLang"></select>
  </div>

  <div>
    <label>🗣 Translate To:</label>
    <select id="targetLang"></select>
  </div>

  <div>
    <button class="reverse" onclick="reverseLanguages()">🔄 Reverse</button>
    <button onclick="startRecognition()">🎙 Start Speaking</button>
  </div>

  <p><b>Original:</b> <span id="original"></span></p>
  <p><b>Translated:</b> <span id="translated"></span></p>
  <p><b>Received:</b> <span id="received"></span></p>
</div>

<script>
// ====== MQTT Setup ======
const mqttHost = "wss://642b85c8c5cd4deaa63d5c7e0e9629fc.s1.eu.hivemq.cloud:8884/mqtt";
const mqttUser = "brengy";
const mqttPass = "Brengy123";
const topic = "translator/chat";

// Generate unique client ID
const clientId = "device_" + Math.random().toString(16).substr(2, 8);

// Connect
const client = mqtt.connect(mqttHost, {
    username: mqttUser,
    password: mqttPass,
    protocolVersion: 4,
    clientId: clientId
});

client.on("connect", () => {
    console.log("Connected to MQTT as", clientId);
    client.subscribe(topic);
});

client.on("message", (t, message) => {
    try {
        const msgObj = JSON.parse(message.toString());
        if (msgObj.sender !== clientId) {
            receivedText.textContent = msgObj.text;
            speak(msgObj.text, targetLangSelect.value);
        }
    } catch (e) {
        console.error("Invalid MQTT message", e);
    }
});

// ====== Languages ======
const languages = {
  "auto": "Auto Detect",
  "en": "English",
  "ar": "Arabic",
  "fr": "French",
  "es": "Spanish",
  "de": "German",
  "ru": "Russian",
  "zh": "Chinese",
  "ja": "Japanese",
  "it": "Italian",
  "tr": "Turkish",
  "pt": "Portuguese",
  "ko": "Korean",
  "nl": "Dutch",
  "sv": "Swedish",
  "pl": "Polish",
  "th": "Thai",
  "id": "Indonesian"
};

const originalText = document.getElementById("original");
const translatedText = document.getElementById("translated");
const receivedText = document.getElementById("received");
const sourceLangSelect = document.getElementById("sourceLang");
const targetLangSelect = document.getElementById("targetLang");

// Fill dropdowns
for (let code in languages) {
    let opt1 = document.createElement("option");
    opt1.value = code; opt1.textContent = languages[code];
    sourceLangSelect.appendChild(opt1);

    let opt2 = document.createElement("option");
    opt2.value = code; opt2.textContent = languages[code];
    targetLangSelect.appendChild(opt2);
}
sourceLangSelect.value = "auto";
targetLangSelect.value = "en";

function reverseLanguages() {
    const temp = sourceLangSelect.value;
    sourceLangSelect.value = targetLangSelect.value;
    targetLangSelect.value = temp;
}

// ====== Speech recognition ======
function startRecognition() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = sourceLangSelect.value === "auto" ? "en-US" : sourceLangSelect.value;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        originalText.textContent = transcript;
        translateText(transcript, targetLangSelect.value);
    };

    recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
    };

    recognition.start();
}

// ====== Translation ======
function translateText(text, targetLang) {
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLangSelect.value}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
    fetch(url)
    .then(res => res.json())
    .then(data => {
        const translated = data[0].map(item => item[0]).join("");
        translatedText.textContent = translated;
        speak(translated, targetLang);
        sendMQTT(translated);
    })
    .catch(err => console.error("Translation error:", err));
}

// ====== Send MQTT ======
function sendMQTT(text) {
    const payload = JSON.stringify({ sender: clientId, text });
    client.publish(topic, payload);
}

// ====== Text-to-Speech ======
function speak(text, langCode) {
    const msg = new SpeechSynthesisUtterance();
    msg.lang = langCode;
    msg.text = text;
    speechSynthesis.speak(msg);
}
</script>
</body>
</html>
