<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Translator (Google + MQTT)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    background: white;
    padding: 25px 30px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    max-width: 450px;
    width: 100%;
    text-align: center;
  }
  h2 { margin-bottom: 15px; color: #333; }
  select, button {
    padding: 10px; font-size: 16px;
    margin: 8px 4px; border-radius: 8px;
    border: 1px solid #ccc; outline: none;
    transition: 0.2s ease;
  }
  select:focus, button:hover {
    border-color: #4facfe;
    box-shadow: 0 0 5px rgba(79,172,254,0.5);
  }
  button { background: #4facfe; color: white; cursor: pointer; border: none; font-weight: bold; }
  button.reverse { background: #ff9800; }
  button:active { transform: scale(0.97); }
  p { font-size: 17px; margin: 10px 0; color: #444; }
  span { font-weight: bold; color: #222; }
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ¤ Multilingual Voice Translator</h2>

  <div>
    <label>ğŸ“± Role:</label>
    <select id="roleSelect">
      <option value="A">Device A</option>
      <option value="B">Device B</option>
    </select>
  </div>

  <div>
    <label>ğŸ§ Listen:</label>
    <select id="sourceLang"></select>
  </div>

  <div>
    <label>ğŸ—£ Translate To:</label>
    <select id="targetLang"></select>
  </div>

  <div>
    <button class="reverse" onclick="reverseLanguages()">ğŸ”„ Reverse</button>
    <button onclick="startRecognition()">ğŸ™ Start Speaking</button>
  </div>

  <p><b>Original:</b> <span id="original"></span></p>
  <p><b>Translated:</b> <span id="translated"></span></p>
  <p><b>Received:</b> <span id="received"></span></p>
</div>

<script>
// ====== MQTT CONFIG ======
const mqttHost = "wss://YOUR_CLUSTER.s1.eu.hivemq.cloud:8884/mqtt"; // Replace
const mqttUser = "YOUR_USERNAME"; // Replace
const mqttPass = "YOUR_PASSWORD"; // Replace

let sendTopic = "";
let receiveTopic = "";

// Connect to HiveMQ
const client = mqtt.connect(mqttHost, {
  username: mqttUser,
  password: mqttPass,
  protocol: "wss"
});

client.on("connect", () => {
  console.log("âœ… MQTT connected");
  setTopics();
});

client.on("message", (topic, message) => {
  const msg = message.toString();
  document.getElementById("received").textContent = msg;
  speak(msg, targetLangSelect.value);
});

// ====== Roles & Topics ======
function setTopics() {
  const role = document.getElementById("roleSelect").value;
  if (role === "A") {
    sendTopic = "translator/deviceA";
    receiveTopic = "translator/deviceB";
  } else {
    sendTopic = "translator/deviceB";
    receiveTopic = "translator/deviceA";
  }
  client.subscribe(receiveTopic);
  console.log(`Role: ${role} | Send: ${sendTopic} | Receive: ${receiveTopic}`);
}

document.getElementById("roleSelect").addEventListener("change", setTopics);

// ====== Language List ======
const languages = {
  "auto": "Auto Detect",
  "en": "English",
  "ar": "Arabic",
  "fr": "French",
  "es": "Spanish",
  "de": "German",
  "ru": "Russian",
  "zh": "Chinese",
  "ja": "Japanese",
  "it": "Italian",
  "tr": "Turkish",
  "pt": "Portuguese",
  "ko": "Korean",
  "nl": "Dutch",
  "sv": "Swedish",
  "pl": "Polish",
  "th": "Thai",
  "id": "Indonesian"
};

const originalText = document.getElementById("original");
const translatedText = document.getElementById("translated");
const sourceLangSelect = document.getElementById("sourceLang");
const targetLangSelect = document.getElementById("targetLang");

for (let code in languages) {
  let opt1 = document.createElement("option");
  opt1.value = code; opt1.textContent = languages[code];
  sourceLangSelect.appendChild(opt1);

  let opt2 = document.createElement("option");
  opt2.value = code; opt2.textContent = languages[code];
  targetLangSelect.appendChild(opt2);
}

sourceLangSelect.value = "auto";
targetLangSelect.value = "en";

// ====== Reverse Button ======
function reverseLanguages() {
  const temp = sourceLangSelect.value;
  sourceLangSelect.value = targetLangSelect.value;
  targetLangSelect.value = temp;
}

// ====== Speech Recognition ======
function startRecognition() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = sourceLangSelect.value === "auto" ? "en-US" : sourceLangSelect.value;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    originalText.textContent = transcript;
    translateText(transcript, targetLangSelect.value);
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
  };

  recognition.start();
}

// ====== Translation ======
function translateText(text, targetLang) {
  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLangSelect.value}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const translated = data[0].map(item => item[0]).join("");
      translatedText.textContent = translated;
      speak(translated, targetLang);
      sendMQTT(translated);
    })
    .catch(err => console.error("Translation error:", err));
}

// ====== MQTT Send ======
function sendMQTT(text) {
  if (client.connected) {
    client.publish(sendTopic, text);
  } else {
    console.error("âŒ MQTT not connected");
  }
}

// ====== TTS ======
function speak(text, langCode) {
  const msg = new SpeechSynthesisUtterance();
  msg.lang = langCode;
  msg.text = text;
  speechSynthesis.speak(msg);
}
</script>

</body>
</html>
